[platformio]
default_envs = sound_reactive
src_dir = ./src
build_dir = ./build

[common]
platform = espressif32@6.4.0
framework = arduino
board = esp32dev
board_build.partitions = default.csv
monitor_speed = 115200
upload_speed = 460800

# Common build flags for sound reactive controller
build_flags =
    -D ARDUINO_ARCH_ESP32
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    # LED Configuration
    -D LEDPIN=2
    -D DEFAULT_LED_COUNT=60
    -D DEFAULT_LED_TYPE=TYPE_WS2812_RGB
    # I2S Microphone Configuration
    -D SR_ENABLE                    # Enable sound reactive
    -D I2S_SDPIN=33                 # I2S Data pin
    -D I2S_WSPIN=25                 # I2S Word Select
    -D I2S_CKPIN=32                 # I2S Clock
    -D MCLK_PIN=0                   # Master clock (0 = not used)
    # Audio Processing
    -D FFT_ENABLED                  # Enable FFT analysis
    -D MIC_LOGGER                   # Log audio levels
    -D SR_SQUELCH=10                # Noise gate
    -D SR_GAIN=50                   # Default gain
    # WLED Features
    -D WLED_ENABLE_WEBSOCKETS
    -D WLED_ENABLE_MQTT
    -D WLED_DISABLE_HUESYNC
    # Memory optimization
    -D WLED_MAX_BUSSES=1
    -D WLED_MAX_SEGMENTS=10

# Common libraries
lib_deps =
    https://github.com/atuline/WLED.git#SR_0.14.0-b0  # Sound Reactive fork
    fastled/FastLED@^3.6.0
    https://github.com/kosme/arduinoFFT.git
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    https://github.com/me-no-dev/AsyncTCP.git

# ====================================
# Sound Reactive Build
# ====================================
[env:sound_reactive]
board = esp32dev
build_flags =
    ${common.build_flags}
lib_deps =
    ${common.lib_deps}

# ====================================
# Sound Reactive - ESP32-S3 (Better Performance)
# ====================================
[env:sound_reactive_s3]
board = esp32-s3-devkitc-1
board_build.arduino.memory_type = qio_opi
build_flags =
    ${common.build_flags}
    -D BOARD_HAS_PSRAM
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D DEFAULT_LED_COUNT=150  # More LEDs possible with PSRAM
lib_deps =
    ${common.lib_deps}

# ====================================
# Debug Build
# ====================================
[env:sound_debug]
board = esp32dev
build_type = debug
build_flags =
    ${common.build_flags}
    -D CORE_DEBUG_LEVEL=5
    -D DEBUG_ESP_PORT=Serial
    -D WLED_DEBUG
    -D SR_DEBUG                     # Sound reactive debug
monitor_filters = esp32_exception_decoder
lib_deps =
    ${common.lib_deps}

# ====================================
# High Sensitivity (Quiet Environments)
# ====================================
[env:sound_high_gain]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D SR_GAIN=80                   # Higher default gain
    -D SR_SQUELCH=5                 # Lower noise gate
lib_deps =
    ${common.lib_deps}

# ====================================
# Party Mode (Loud Environments)
# ====================================
[env:sound_party]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D SR_GAIN=30                   # Lower gain for loud music
    -D SR_SQUELCH=20                # Higher noise gate
    -D DEFAULT_BRIGHTNESS=255       # Maximum brightness
lib_deps =
    ${common.lib_deps}

# ====================================
# Low Power (30 LEDs, USB Powered)
# ====================================
[env:sound_30led]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D DEFAULT_LED_COUNT=30
    -D WLED_MAX_CURRENT=2000        # 2A for USB power
    -D DEFAULT_BRIGHTNESS=128
lib_deps =
    ${common.lib_deps}

# ====================================
# Large Installation (150+ LEDs)
# ====================================
[env:sound_150led]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D DEFAULT_LED_COUNT=150
    -D WLED_MAX_CURRENT=8000        # 8A
lib_deps =
    ${common.lib_deps}

# ====================================
# OTA Update
# ====================================
[env:sound_ota]
board = esp32dev
upload_protocol = espota
upload_port = wled-sound.local
upload_flags =
    --port=3232
    --auth=wledota
build_flags =
    ${common.build_flags}
lib_deps =
    ${common.lib_deps}

# ====================================
# Test - Microphone Only (No LEDs)
# ====================================
[env:mic_test]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D SR_ENABLE
    -D MIC_LOGGER
    -D DEFAULT_LED_COUNT=1          # Minimal LEDs
lib_deps =
    ${common.lib_deps}
