[platformio]
default_envs = moon_basic
src_dir = ./src
build_dir = ./build

[common]
platform = espressif32@6.4.0
framework = arduino
board = esp32dev
board_build.partitions = default.csv
monitor_speed = 115200
upload_speed = 460800

# Common build flags for moon/ambient lighting
build_flags =
    -D ARDUINO_ARCH_ESP32
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    # LED Configuration - RGBW!
    -D LEDPIN=2
    -D DEFAULT_LED_COUNT=120            # 2m @ 60 LED/m
    -D DEFAULT_LED_TYPE=TYPE_SK6812_RGBW  # RGBW type
    -D LED_COLOR_ORDER_GRBW            # Color order with white
    # Default to warm white
    -D DEFAULT_BRIGHTNESS=150
    # WLED Features
    -D WLED_ENABLE_WEBSOCKETS
    -D WLED_ENABLE_MQTT
    -D WLED_ENABLE_ADALIGHT
    -D WLED_DISABLE_HUESYNC
    # Circadian rhythm support
    -D USERMOD_AUTO_SAVE
    -D WLED_ENABLE_TIME
    # Power management
    -D WLED_MAX_CURRENT=6000           # 6A for 120 LEDs (white mode)
    -D WLED_ABL_MILLIAMPS_DEFAULT=6000

# Common libraries
lib_deps =
    https://github.com/Aircoookie/WLED.git#v0.14.0
    fastled/FastLED@^3.6.0
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    https://github.com/me-no-dev/AsyncTCP.git

# ====================================
# Basic Moon/Ambient Build
# ====================================
[env:moon_basic]
board = esp32dev
build_flags =
    ${common.build_flags}
lib_deps =
    ${common.lib_deps}

# ====================================
# With PIR and Light Sensor
# ====================================
[env:moon_sensors]
board = esp32dev
build_flags =
    ${common.build_flags}
    # PIR Motion Sensor
    -D USERMOD_PIR_SENSOR
    -D PIR_SENSOR_PIN=4
    -D PIR_SENSOR_OFF_SEC=300          # 5 min timeout
    # BH1750 Light Sensor
    -D USERMOD_BH1750
    -D USERMOD_BH1750_MAX_MEASUREMENT_INTERVAL=10000
lib_deps =
    ${common.lib_deps}
    claws/BH1750@^1.3.0

# ====================================
# Circadian Rhythm Optimized
# ====================================
[env:moon_circadian]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D USERMOD_AUTO_SAVE
    -D AUTO_SAVE_INTERVAL_SEC=3600     # Save state hourly
lib_deps =
    ${common.lib_deps}

# ====================================
# Small Installation (30 LEDs, USB)
# ====================================
[env:moon_30led]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D DEFAULT_LED_COUNT=30
    -D WLED_MAX_CURRENT=1500           # USB power safe
    -D DEFAULT_BRIGHTNESS=128
lib_deps =
    ${common.lib_deps}

# ====================================
# Medium Installation (60 LEDs)
# ====================================
[env:moon_60led]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D DEFAULT_LED_COUNT=60
    -D WLED_MAX_CURRENT=3000
lib_deps =
    ${common.lib_deps}

# ====================================
# Large Installation (180 LEDs)
# ====================================
[env:moon_180led]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D DEFAULT_LED_COUNT=180
    -D WLED_MAX_CURRENT=9000           # 9A, need good PSU
lib_deps =
    ${common.lib_deps}

# ====================================
# Natural White (4000K strips)
# ====================================
[env:moon_natural]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D DEFAULT_BRIGHTNESS=180          # Brighter for natural white
lib_deps =
    ${common.lib_deps}

# ====================================
# Warm White (3000K strips)
# ====================================
[env:moon_warm]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D DEFAULT_BRIGHTNESS=120          # Dimmer for cozy feel
lib_deps =
    ${common.lib_deps}

# ====================================
# Debug Build
# ====================================
[env:moon_debug]
board = esp32dev
build_type = debug
build_flags =
    ${common.build_flags}
    -D CORE_DEBUG_LEVEL=5
    -D DEBUG_ESP_PORT=Serial
    -D WLED_DEBUG
monitor_filters = esp32_exception_decoder
lib_deps =
    ${common.lib_deps}

# ====================================
# OTA Update
# ====================================
[env:moon_ota]
board = esp32dev
upload_protocol = espota
upload_port = wled-moon.local
upload_flags =
    --port=3232
    --auth=wledota
build_flags =
    ${common.build_flags}
lib_deps =
    ${common.lib_deps}

# ====================================
# ESP32-S3 (PSRAM, more LEDs)
# ====================================
[env:moon_s3]
board = esp32-s3-devkitc-1
board_build.arduino.memory_type = qio_opi
build_flags =
    ${common.build_flags}
    -D BOARD_HAS_PSRAM
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D DEFAULT_LED_COUNT=300           # More LEDs with PSRAM
    -D WLED_MAX_CURRENT=15000          # 15A
lib_deps =
    ${common.lib_deps}
