[platformio]
default_envs = esp32_basic
src_dir = ./src
build_dir = ./build
data_dir = ./data

[common]
platform = espressif32@6.4.0
framework = arduino
board = esp32dev
board_build.partitions = min_spiffs.csv
monitor_speed = 115200
upload_speed = 460800

# Common build flags for basic controller
build_flags =
    -D ARDUINO_ARCH_ESP32
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    # LED Configuration
    -D LEDPIN=2
    -D DEFAULT_LED_COUNT=60
    -D DEFAULT_LED_TYPE=TYPE_WS2812_RGB
    # Button Configuration
    -D BTNPIN=0
    -D BTN_ACTIVE_LOW
    # WiFi Configuration
    -D WLED_AP_SSID=\"WLED-AP\"
    -D WLED_AP_PASS=\"wled1234\"
    # Enable core features
    -D WLED_ENABLE_WEBSOCKETS
    -D WLED_ENABLE_MQTT
    -D WLED_ENABLE_ADALIGHT
    # Disable unused features to save space
    -D WLED_DISABLE_HUESYNC
    -D WLED_DISABLE_INFRARED
    # Memory optimization
    -D WLED_MAX_BUSSES=1
    -D WLED_MAX_USERMODS=0

# Common libraries
lib_deps =
    https://github.com/Aircoookie/WLED.git#v0.14.0
    fastled/FastLED@^3.6.0
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    https://github.com/me-no-dev/AsyncTCP.git

# ====================================
# Basic ESP32 Configuration
# ====================================
[env:esp32_basic]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D ENV_NAME=\"basic\"
lib_deps =
    ${common.lib_deps}

# ====================================
# Debug Build
# ====================================
[env:esp32_debug]
board = esp32dev
build_type = debug
build_flags =
    ${common.build_flags}
    -D CORE_DEBUG_LEVEL=5
    -D DEBUG_ESP_PORT=Serial
    -D WLED_DEBUG
monitor_filters = esp32_exception_decoder
lib_deps =
    ${common.lib_deps}

# ====================================
# Release Build (Optimized)
# ====================================
[env:esp32_release]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D RELEASE_BUILD
    -Os
    -D NDEBUG
build_unflags = -O2
lib_deps =
    ${common.lib_deps}

# ====================================
# OTA Update Build
# ====================================
[env:esp32_ota]
board = esp32dev
upload_protocol = espota
upload_port = wled-controller.local
; Or use IP address: upload_port = 192.168.1.XXX
upload_flags =
    --port=3232
    --auth=wledota
build_flags =
    ${common.build_flags}
lib_deps =
    ${common.lib_deps}

# ====================================
# 30 LEDs (Lower Power)
# ====================================
[env:esp32_30led]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D DEFAULT_LED_COUNT=30
    -D DEFAULT_BRIGHTNESS=128
lib_deps =
    ${common.lib_deps}

# ====================================
# 150 LEDs (More LEDs)
# ====================================
[env:esp32_150led]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D DEFAULT_LED_COUNT=150
    -D DEFAULT_BRIGHTNESS=128
lib_deps =
    ${common.lib_deps}

# ====================================
# Custom GPIO Configuration
# ====================================
[env:esp32_custom_gpio]
board = esp32dev
build_flags =
    ${common.build_flags}
    -D LEDPIN=4          ; Change LED pin
    -D BTNPIN=0          ; Button pin
lib_deps =
    ${common.lib_deps}

# ====================================
# ESP32-C3 Support
# ====================================
[env:esp32c3]
board = esp32-c3-devkitm-1
platform = espressif32
build_flags =
    ${common.build_flags}
    -D ARDUINO_USB_CDC_ON_BOOT=1
lib_deps =
    ${common.lib_deps}

# ====================================
# ESP32-S3 Support (with PSRAM)
# ====================================
[env:esp32s3]
board = esp32-s3-devkitc-1
platform = espressif32
board_build.arduino.memory_type = qio_opi
build_flags =
    ${common.build_flags}
    -D BOARD_HAS_PSRAM
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D DEFAULT_LED_COUNT=300    ; More LEDs possible with PSRAM
lib_deps =
    ${common.lib_deps}

# ====================================
# Test Environment
# ====================================
[env:test]
platform = native
test_framework = unity
build_flags =
    -D UNIT_TEST
    -std=c++11
